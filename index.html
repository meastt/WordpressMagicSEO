<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Magic SEO - AI Portfolio Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
        }

        .app-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 40px;
        }

        .nav-tab {
            padding: 16px 32px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Dashboard View */
        .dashboard-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .quick-create-section {
            margin-top: 48px;
            padding-top: 48px;
            border-top: 2px solid #e8e8e8;
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
        }

        .section-description {
            font-size: 14px;
            color: #888;
            margin: 0;
        }

        .quick-create-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 32px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .quick-create-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .quick-create-actions .btn-secondary {
            flex: 1;
        }

        .quick-create-actions .btn-primary {
            flex: 2;
        }

        .site-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .site-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .site-card:hover::before {
            transform: scaleX(1);
        }

        .site-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .site-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .site-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .site-status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }

        .site-status.complete {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .site-status.ready {
            background: #e3f2fd;
            color: #1976d2;
        }

        .site-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            text-align: center;
            padding: 16px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 10px;
            border: 1px solid #e8e8e8;
            transition: all 0.2s;
        }

        .stat-box:hover {
            transform: scale(1.05);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .site-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        /* Execute View */
        .execute-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .execute-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .execute-subtitle {
            font-size: 15px;
            color: #666;
        }

        .execute-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .workflow-step {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .workflow-step:hover {
            border-color: #d0d0d0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }

        .continue-panel {
            margin-top: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .continue-panel-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .continue-panel-content {
            flex: 1;
        }

        .continue-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #1565c0;
            margin: 0 0 8px 0;
        }

        .continue-panel-text {
            font-size: 14px;
            color: #333;
            margin: 0 0 16px 0;
        }

        .continue-panel-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .required-badge {
            display: inline-block;
            background: #f44336;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .optional-badge {
            display: inline-block;
            background: #9e9e9e;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .file-upload-area.enhanced {
            border: 3px dashed #d0d0d0;
            padding: 40px;
        }

        .file-upload-area.enhanced.optional {
            border-color: #e8e8e8;
            background: #fafafa;
        }

        .file-upload-area.enhanced .upload-text {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-upload-area.enhanced .upload-text strong {
            font-size: 16px;
            color: #333;
        }

        .file-upload-area.enhanced .upload-text span {
            font-size: 13px;
            color: #888;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            line-height: 1.6;
        }

        .help-text strong {
            color: #333;
            font-weight: 600;
        }

        .help-text a {
            color: #667eea;
            text-decoration: none;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-text {
            color: #666;
            font-weight: 600;
        }

        .file-name-display {
            margin-top: 12px;
            color: #667eea;
            font-weight: 600;
            display: none;
        }

        .file-name-display:not(:empty) {
            display: block;
        }

        .execution-mode-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .mode-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .mode-option.selected {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .mode-option input[type="radio"] {
            display: none;
        }

        .mode-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .mode-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .mode-desc {
            font-size: 12px;
            color: #666;
        }

        .btn-large {
            width: 100%;
            padding: 18px 32px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .btn-large:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Settings View */
        .settings-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid #e8e8e8;
        }

        .settings-page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .settings-page-subtitle {
            font-size: 15px;
            color: #666;
            margin: 0;
        }

        .settings-section {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .settings-section:hover {
            border-color: #d0d0d0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-description {
            font-size: 14px;
            color: #888;
            margin-bottom: 24px;
        }

        .input-with-button {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .input-with-button input {
            flex: 1;
        }

        .btn-save {
            padding: 12px 24px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .settings-status {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .settings-status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .settings-status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .sites-config-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .site-config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
        }

        .site-config-item:last-child {
            margin-bottom: 0;
        }

        .site-config-name {
            font-weight: 600;
            color: #333;
        }

        .site-config-status {
            font-size: 12px;
            color: #4caf50;
        }

        .feature-status-box {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            border: 2px solid #ffb74d;
        }

        .status-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .status-content h4 {
            font-size: 16px;
            font-weight: 600;
            color: #e65100;
            margin: 0 0 8px 0;
        }

        .status-content p {
            font-size: 14px;
            color: #666;
            margin: 0;
            line-height: 1.6;
        }

        .state-management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .state-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .state-card:hover {
            transform: translateY(-4px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }

        .state-card.danger {
            border-color: #ffcdd2;
        }

        .state-card.danger:hover {
            border-color: #f44336;
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.15);
        }

        .state-card-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .state-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .state-card-desc {
            font-size: 13px;
            color: #888;
        }

        .loading-placeholder {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        /* Loading and Results */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 24px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .spinner::after {
            display: none; /* Remove the nested circle */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-counter {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
            margin-top: 16px;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            margin-top: 24px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            position: relative;
            animation: shimmer 2s infinite;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: slideProgress 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes slideProgress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .results-panel {
            display: none;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            margin-top: 24px;
        }

        .results-panel.show {
            display: block;
        }

        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 10px 10px 0 0;
        }

        .results-body {
            padding: 24px;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .alert-error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .alert-info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content.large {
            max-width: 1000px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Welcome Modal */
        .welcome-modal .modal-content {
            max-width: 800px;
        }

        .welcome-hero {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        .welcome-hero h1 {
            font-size: 36px;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .welcome-hero p {
            font-size: 18px;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .welcome-step {
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .welcome-step:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .welcome-step-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .welcome-step-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .welcome-step-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 24px 0;
        }

        .feature-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .feature-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text strong {
            display: block;
            margin-bottom: 4px;
            color: #333;
        }

        .feature-text span {
            font-size: 14px;
            color: #666;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .empty-state p {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state .btn-large {
            max-width: 400px;
            margin: 0 auto;
        }

        /* Tooltips */
        .tooltip-trigger {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #667eea;
            margin-left: 4px;
        }

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .tooltip-trigger:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Action Plan Modal */
        .action-plan-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e0e0e0;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .control-buttons button {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .control-buttons button:hover {
            background: #667eea;
            color: white;
        }

        .selection-stats {
            font-weight: 600;
            color: #667eea;
        }

        .action-plan-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .action-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .action-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .action-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .action-item.completed {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .action-item-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .action-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .action-badges {
            display: flex;
            gap: 8px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.create {
            background: #4caf50;
            color: white;
        }

        .badge.update {
            background: #2196f3;
            color: white;
        }

        .badge.redirect_301 {
            background: #9c27b0;
            color: white;
        }

        .badge.delete {
            background: #f44336;
            color: white;
        }

        .badge.pending {
            background: #ff9800;
            color: white;
        }

        .badge.completed {
            background: #9e9e9e;
            color: white;
        }

        .action-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .action-details {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .action-url {
            color: #667eea;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .action-priority {
            display: inline-block;
            background: #fffde7;
            color: #f57f17;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .action-keywords {
            font-size: 12px;
            color: #9e9e9e;
            margin-top: 4px;
        }

        /* Confirmation Modal */
        .confirmation-message {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .confirmation-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .confirmation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .confirmation-item-number {
            font-weight: 700;
            color: #667eea;
            min-width: 24px;
        }

        .confirmation-item-content {
            flex: 1;
        }

        .confirmation-item-remove {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .confirmation-summary {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast.success {
            border-color: #4caf50;
        }

        .toast.error {
            border-color: #f44336;
        }

        .toast.info {
            border-color: #2196f3;
        }

        .toast.warning {
            border-color: #ff9800;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .execution-mode-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .content-area {
                padding: 20px;
            }

            .modal-content {
                max-width: 95%;
            }

            .action-plan-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .welcome-steps {
                grid-template-columns: 1fr;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }

            .welcome-hero h1 {
                font-size: 28px;
            }

            .welcome-hero p {
                font-size: 16px;
            }

            .app-header {
                padding: 16px 20px;
            }

            .app-title {
                font-size: 18px;
            }

            .toast-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .empty-state {
                padding: 40px 20px;
            }

            .empty-state-icon {
                font-size: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="app-title">üéØ WordPress Magic SEO</div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <button onclick="showWelcomeModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    üìñ Help
                </button>
                <div class="app-badge">v3.0 AI</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('dashboard')">üìä Dashboard</div>
            <div class="nav-tab" onclick="switchView('execute')">üöÄ Execute</div>
            <div class="nav-tab" onclick="switchView('settings')">‚öôÔ∏è Settings</div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Your SEO Portfolio</h1>
                    <p class="dashboard-subtitle">
                        Track and manage AI-powered SEO optimizations across all your WordPress sites
                    </p>
                </div>
                <div id="dashboard-grid" class="dashboard-grid">
                    <!-- Site cards will be loaded here -->
                </div>

                <!-- Quick Create Card -->
                <div class="quick-create-section">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">‚ö° Quick Create Content</h2>
                            <p class="section-description">Generate AI content without GSC data - just enter your topics</p>
                        </div>
                    </div>
                    <div class="quick-create-card">
                        <div class="form-group">
                            <label>Target WordPress Site</label>
                            <select id="quick_create_site" class="form-control">
                                <option value="">-- Select a site --</option>
                            </select>
                        </div>

                        <div id="quick_create_forms">
                            <!-- Dynamic post forms will be added here -->
                        </div>

                        <div class="quick-create-actions">
                            <button type="button" class="btn-secondary" onclick="addQuickCreateForm()">
                                ‚ûï Add Another Post
                            </button>
                            <button type="button" class="btn-primary" onclick="submitQuickCreate()">
                                ‚ú® Create Posts with AI
                            </button>
                        </div>

                        <div class="alert alert-info">
                            üí° <strong>How it works:</strong> Enter your topic and target keywords. The AI will research the topic and create a fully SEO-optimized article ready for publishing.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Execute View -->
            <div id="execute-view" class="view">
                <div class="execute-container">
                    <div class="execute-header">
                        <h2 class="execute-title">üöÄ AI-Powered SEO Execution</h2>
                        <p class="execute-subtitle">Upload your data, let AI analyze it, and execute strategic improvements</p>
                    </div>

                    <!-- Step 1: Select Site -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">Select WordPress Site</div>
                        </div>
                        <div class="form-group">
                            <label for="exec_site_selector">Choose a site to optimize</label>
                            <select id="exec_site_selector">
                                <option value="">-- Select a site --</option>
                            </select>
                            <div class="help-text">Sites are configured in your Vercel environment variables</div>
                        </div>

                        <!-- Continue Execution Panel (shown when site has pending actions) -->
                        <div id="continue_panel" class="continue-panel" style="display: none;">
                            <div class="continue-panel-icon">üìã</div>
                            <div class="continue-panel-content">
                                <h4 class="continue-panel-title">Existing Action Plan Found</h4>
                                <p class="continue-panel-text">This site has pending actions ready to execute.</p>
                                <div class="form-group" style="margin: 16px 0;">
                                    <label for="continue_limit">Batch Size (Optional)</label>
                                    <input type="number" id="continue_limit" min="1" placeholder="Leave empty to run all pending actions">
                                </div>
                                <div class="continue-panel-actions">
                                    <button class="btn-small btn-primary" onclick="continueExecution()">‚ñ∂Ô∏è Continue Execution</button>
                                    <button class="btn-small btn-secondary" onclick="viewCurrentPlan()">üëÅÔ∏è View Plan</button>
                                    <button class="btn-small btn-secondary" onclick="deleteCurrentPlan()">üóëÔ∏è Delete Plan</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Upload Data -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">Upload Analytics Data</div>
                        </div>

                        <div class="form-group">
                            <label>Google Search Console Data <span class="required-badge">Required</span></label>
                            <div class="file-upload-area enhanced" onclick="document.getElementById('gsc_file_input').click()">
                                <input type="file" id="gsc_file_input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect('gsc')">
                                <div class="upload-icon">üìä</div>
                                <div class="upload-text">
                                    <strong>Click or drag to upload GSC data</strong>
                                    <span>CSV or Excel format accepted</span>
                                </div>
                                <div id="gsc_file_name" class="file-name-display"></div>
                            </div>
                            <div class="help-text">
                                <strong>How to export:</strong> GSC ‚Üí Performance ‚Üí Export ‚Üí Download CSV<br>
                                <strong>Data needed:</strong> Last 12 months with queries, pages, clicks, impressions, CTR, and position
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Google Analytics 4 Data <span class="optional-badge">Optional</span></label>
                            <div class="file-upload-area enhanced optional" onclick="document.getElementById('ga4_file_input').click()">
                                <input type="file" id="ga4_file_input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect('ga4')">
                                <div class="upload-icon">üìà</div>
                                <div class="upload-text">
                                    <strong>Upload GA4 data for deeper insights</strong>
                                    <span>Adds engagement metrics to the analysis</span>
                                </div>
                                <div id="ga4_file_name" class="file-name-display"></div>
                            </div>
                            <div class="help-text">
                                Include engagement rate, bounce rate, and session duration for more comprehensive analysis
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Choose Execution Mode -->
                    <div class="workflow-step">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-title">Choose Execution Mode</div>
                        </div>

                        <div class="execution-mode-grid">
                            <div class="mode-option selected" onclick="selectMode('view_plan')">
                                <input type="radio" name="exec_mode" value="view_plan" checked>
                                <div class="mode-icon">üìã</div>
                                <div class="mode-title">View Plan</div>
                                <div class="mode-desc">Safe: Just analyze & create action plan</div>
                            </div>

                            <div class="mode-option" onclick="selectMode('execute_top_n')">
                                <input type="radio" name="exec_mode" value="execute_top_n">
                                <div class="mode-icon">üéØ</div>
                                <div class="mode-title">Execute Batch</div>
                                <div class="mode-desc">Run top priority actions only</div>
                            </div>

                            <div class="mode-option" onclick="selectMode('execute_all')">
                                <input type="radio" name="exec_mode" value="execute_all">
                                <div class="mode-icon">üöÄ</div>
                                <div class="mode-title">Execute All</div>
                                <div class="mode-desc">Full automation: run everything</div>
                            </div>
                        </div>

                        <div id="batch_limit_field" style="display: none; margin-top: 20px;">
                            <div class="form-group">
                                <label for="exec_limit">Number of Actions</label>
                                <input type="number" id="exec_limit" value="5" min="1">
                                <div class="help-text">Execute the top N highest-priority actions</div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="force_new_plan" style="width: auto;">
                                <span>Force New Analysis (ignore existing plan)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Execute Button -->
                    <button id="execute_btn" class="btn-large" onclick="runPipeline()">
                        ü§ñ Start AI Analysis
                    </button>
                </div>

                <!-- Results Panel -->
                <div id="results_panel" class="results-panel">
                    <!-- Results will be inserted here -->
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view">
                <div class="settings-header">
                    <h2 class="settings-page-title">‚öôÔ∏è Settings & Configuration</h2>
                    <p class="settings-page-subtitle">Configure your WordPress sites and API credentials</p>
                </div>

                <!-- API Configuration -->
                <div class="settings-section">
                    <div class="settings-title">üîë API Configuration</div>
                    <div class="settings-description">Configure your Anthropic API key for AI-powered content generation</div>
                    <div class="form-group">
                        <label for="settings_anthropic_key">Anthropic API Key</label>
                        <div class="input-with-button">
                            <input type="password" id="settings_anthropic_key" placeholder="sk-ant-api03-...">
                            <button class="btn-save" onclick="saveApiKey()">üíæ Save</button>
                        </div>
                        <div class="help-text">
                            <strong>Where to get your key:</strong> Visit <a href="https://console.anthropic.com" target="_blank" rel="noopener">console.anthropic.com</a><br>
                            <strong>Alternative:</strong> Set ANTHROPIC_API_KEY as an environment variable in Vercel
                        </div>
                    </div>
                    <div id="api_key_status" class="settings-status" style="display: none;"></div>
                </div>

                <!-- WordPress Sites -->
                <div class="settings-section">
                    <div class="settings-title">üåê WordPress Sites</div>
                    <div class="settings-description">Your sites are automatically loaded from Vercel environment variables</div>
                    <div id="sites_list" class="sites-config-list">
                        <div class="loading-placeholder">Loading sites...</div>
                    </div>
                    <div class="help-text">
                        <strong>To add new sites:</strong> Configure them as environment variables in Vercel (WORDPRESS_SITE_NAME_URL and WORDPRESS_SITE_NAME_USER_PASS)
                    </div>
                </div>

                <!-- Affiliate Links -->
                <div class="settings-section">
                    <div class="settings-title">üîó Affiliate Links</div>
                    <div class="settings-description">Configure affiliate links that will be automatically inserted into your content</div>
                    <div class="feature-status-box">
                        <div class="status-icon">üöß</div>
                        <div class="status-content">
                            <h4>Coming in Next Update</h4>
                            <p>Affiliate link management interface is currently in development. For now, affiliate links can be configured via the backend API.</p>
                        </div>
                    </div>
                </div>

                <!-- State Management -->
                <div class="settings-section">
                    <div class="settings-title">üíæ Action Plans & State</div>
                    <div class="settings-description">Manage saved action plans and execution state for your sites</div>
                    <div class="state-management-grid">
                        <div class="state-card" onclick="exportAllStates()">
                            <div class="state-card-icon">üì•</div>
                            <div class="state-card-title">Export States</div>
                            <div class="state-card-desc">Download all action plans as JSON</div>
                        </div>
                        <div class="state-card" onclick="viewAllStates()">
                            <div class="state-card-icon">üìä</div>
                            <div class="state-card-title">View States</div>
                            <div class="state-card-desc">Review all saved action plans</div>
                        </div>
                        <div class="state-card danger" onclick="confirmClearAllStates()">
                            <div class="state-card-icon">üóëÔ∏è</div>
                            <div class="state-card-title">Clear All</div>
                            <div class="state-card-desc">Delete all saved states</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading_overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading_text" class="loading-text">Processing...</div>
            <div id="progress_counter" class="progress-counter" style="display: none;">0/0</div>
            <div class="progress-bar-container" id="progress_bar_container" style="display: none;">
                <div id="progress_bar" class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Action Plan Modal -->
    <div id="action_plan_modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="action_plan_modal_title">Action Plan</h2>
                <button class="modal-close" onclick="closeActionPlanModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="action-plan-controls">
                    <div class="control-buttons">
                        <button onclick="selectAllActions()">Select All</button>
                        <button onclick="deselectAllActions()">Deselect All</button>
                        <button onclick="togglePendingOnly()" id="pending_only_btn">Show Pending Only</button>
                        <button onclick="deleteSelectedActions()" style="border-color: #f44336; color: #f44336;" id="delete_selected_btn">üóëÔ∏è Delete Selected</button>
                    </div>
                    <div class="selection-stats">
                        <span id="selection_count">0 selected</span>
                    </div>
                </div>
                <div id="action_plan_list" class="action-plan-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeActionPlanModal()">Close</button>
                <button class="btn-primary" onclick="executeSelectedActions()" id="execute_selected_btn">Execute Selected</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation_modal" class="modal">
        <div class="modal-content">
            <div class="modal-header warning">
                <h2>‚ö†Ô∏è Confirm Execution</h2>
                <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="confirmation-message" id="confirmation_message">You're about to execute <strong id="confirm_count">0</strong> actions:</p>
                <div id="confirmation_list" class="confirmation-list"></div>
                <div class="confirmation-summary">
                    <strong>Summary:</strong> <span id="confirmation_summary"></span>
                </div>
                
                <!-- Image Generation Toggle -->
                <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="generate_images_toggle" style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">üñºÔ∏è Generate AI Images</div>
                            <div style="font-size: 13px; color: #666;">Automatically generate images using Google Gemini AI for image placeholders in content</div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeConfirmationModal()">Cancel</button>
                <button class="btn-primary btn-warning" onclick="confirmExecution()" id="confirm_execute_btn">Confirm & Execute</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome_modal" class="modal welcome-modal">
        <div class="modal-content">
            <div class="welcome-hero">
                <h1>üéØ Welcome to WordPress Magic SEO</h1>
                <p>AI-powered SEO automation for affiliate publishers and bloggers</p>
            </div>
            <div class="modal-body">
                <h3 style="text-align: center; margin-bottom: 24px; color: #333;">Get Started in 3 Easy Steps</h3>

                <div class="welcome-steps">
                    <div class="welcome-step">
                        <div class="welcome-step-icon">üìä</div>
                        <div class="welcome-step-title">1. Upload Data</div>
                        <div class="welcome-step-desc">Export your Google Search Console data (last 12 months) and optionally GA4 metrics</div>
                    </div>
                    <div class="welcome-step">
                        <div class="welcome-step-icon">ü§ñ</div>
                        <div class="welcome-step-title">2. AI Analysis</div>
                        <div class="welcome-step-desc">Claude AI analyzes your data and creates a strategic action plan</div>
                    </div>
                    <div class="welcome-step">
                        <div class="welcome-step-icon">üöÄ</div>
                        <div class="welcome-step-title">3. Execute</div>
                        <div class="welcome-step-desc">Review and execute actions to optimize your content automatically</div>
                    </div>
                </div>

                <h4 style="margin-bottom: 16px; color: #333;">‚ú® What This Tool Does:</h4>
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="feature-icon">üîç</div>
                        <div class="feature-text">
                            <strong>Smart Analysis</strong>
                            <span>Identifies underperforming content and missed opportunities</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">‚úçÔ∏è</div>
                        <div class="feature-text">
                            <strong>Content Generation</strong>
                            <span>Creates SEO-optimized articles with web research</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìà</div>
                        <div class="feature-text">
                            <strong>Trend Detection</strong>
                            <span>Spots trending vs declining content automatically</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üéØ</div>
                        <div class="feature-text">
                            <strong>Year-Aware Updates</strong>
                            <span>Keeps your "Best of 2025" content fresh and current</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üîó</div>
                        <div class="feature-text">
                            <strong>Auto Publishing</strong>
                            <span>Publishes directly to WordPress with proper formatting</span>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üìä</div>
                        <div class="feature-text">
                            <strong>Schema Markup</strong>
                            <span>Adds structured data for better search visibility</span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info" style="margin-top: 24px;">
                    <strong>üí° Pro Tip:</strong> Start by uploading your GSC data in the Execute tab. The AI will create an action plan showing exactly what needs improvement on your site.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-large btn-primary" onclick="closeWelcomeModal()" style="width: 100%;">
                    üöÄ Let's Get Started!
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast_container"></div>

    <script>
        const API_BASE = '/api';
        let sitesData = [];

        // =================================================================
        // TOAST NOTIFICATION SYSTEM
        // =================================================================

        function showToast(title, message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast_container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => removeToast(toast), duration);
            }

            return toast;
        }

        function removeToast(toast) {
            if (!toast || !toast.parentElement) return;
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            await loadSites();
            populateSiteSelectors();

            // Show welcome modal on first visit
            const hasVisited = localStorage.getItem('wp_magic_seo_visited');
            if (!hasVisited) {
                setTimeout(() => showWelcomeModal(), 500);
                localStorage.setItem('wp_magic_seo_visited', 'true');
            }
        }

        // Welcome Modal Functions
        function showWelcomeModal() {
            document.getElementById('welcome_modal').classList.add('show');
        }

        function closeWelcomeModal() {
            document.getElementById('welcome_modal').classList.remove('show');
        }

        // View Switching
        function switchView(viewName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.includes(viewName === 'dashboard' ? 'üìä Dashboard' : viewName === 'execute' ? 'üöÄ Execute' : '‚öôÔ∏è Settings')) {
                    tab.classList.add('active');
                }
            });

            // Update active view
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName + '-view').classList.add('active');
            
            // Refresh dashboard when switching to it
            if (viewName === 'dashboard') {
                loadSites().then(() => renderDashboard());
            }
        }

        // Load Sites
        async function loadSites() {
            try {
                const response = await fetch(`${API_BASE}/sites`);
                const data = await response.json().catch(() => null);
                
                if (response.ok && data) {
                    sitesData = data.sites || [];
                    console.log('Loaded sites:', sitesData);
                    if (data.error) {
                        console.warn('Sites loaded with warning:', data.error);
                    }
                    renderDashboard();
                } else {
                    const errorMsg = data?.error || data?.details || `HTTP ${response.status}`;
                    console.error('Failed to load sites - API error:', response.status, errorMsg);
                    console.error('Full error data:', data);
                    
                    // Show sites even if API fails (empty array)
                    sitesData = [];
                    renderDashboard();
                    
                    // Show user-friendly error message
                    showToast(`‚ö†Ô∏è Could not load sites: ${errorMsg}`, 'warning');
                }
            } catch (e) {
                console.error('Failed to load sites:', e);
                // Show empty state even if fetch fails
                sitesData = [];
                renderDashboard();
                showToast('‚ö†Ô∏è Failed to connect to server. Please refresh the page.', 'error');
            }
        }

        // Render Dashboard
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            // Show empty state if no sites with action plans
            if (sitesData.length === 0 || sitesData.every(s => s.total_actions === 0)) {
                grid.innerHTML = `
                    <div class="empty-state fade-in-up" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üéØ</div>
                        <h3>Ready to Optimize Your WordPress Sites?</h3>
                        <p>Upload your Google Search Console data to get started. Our AI will analyze your content and create a strategic action plan to boost your SEO performance.</p>
                        <button class="btn-large" onclick="switchView('execute')">
                            üöÄ Start Your First Analysis
                        </button>
                        <div style="margin-top: 24px;">
                            <button class="btn-secondary" onclick="showWelcomeModal()" style="padding: 12px 24px;">
                                üìñ View Getting Started Guide
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            sitesData.forEach(site => {
                const card = document.createElement('div');
                card.className = 'site-card';
                card.onclick = () => selectSiteFromDashboard(site.name);

                let statusClass = 'ready';
                let statusText = 'Ready';
                if (site.pending_actions > 0) {
                    statusClass = 'pending';
                    statusText = 'In Progress';
                } else if (site.completed_actions > 0) {
                    statusClass = 'complete';
                    statusText = 'Complete';
                }

                card.innerHTML = `
                    <div class="site-card-header">
                        <div class="site-name">${site.name}</div>
                        <div class="site-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="site-stats">
                        <div class="stat-box">
                            <div class="stat-value">${site.total_actions || 0}</div>
                            <div class="stat-label">Actions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${site.completed_actions || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${site.pending_actions || 0}</div>
                            <div class="stat-label">Remaining</div>
                        </div>
                    </div>
                    <div class="site-actions">
                        <button class="btn-small btn-primary" onclick="event.stopPropagation(); selectSiteAndExecute('${site.name}')">
                            ${site.pending_actions > 0 ? '‚ñ∂Ô∏è Continue Execution' : 'üöÄ Start New'}
                        </button>
                        ${site.pending_actions > 0 ? `
                            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); viewSitePlan('${site.name}')">
                                üëÅÔ∏è View Plan
                            </button>
                        ` : ''}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Populate Site Selectors
        function populateSiteSelectors() {
            const selector = document.getElementById('exec_site_selector');
            selector.innerHTML = '<option value="">-- Select a site --</option>';

            const quickSelector = document.getElementById('quick_create_site');
            quickSelector.innerHTML = '<option value="">-- Select a site --</option>';

            sitesData.forEach(site => {
                const option = document.createElement('option');
                option.value = site.name;
                option.textContent = site.name;
                selector.appendChild(option);

                const quickOption = document.createElement('option');
                quickOption.value = site.name;
                quickOption.textContent = site.name;
                quickSelector.appendChild(quickOption);
            });

            // Initialize with one quick create form
            addQuickCreateForm();
        }

        // Site Selection
        document.getElementById('exec_site_selector')?.addEventListener('change', function() {
            const siteName = this.value;
            const site = sitesData.find(s => s.name === siteName);
            const continuePanel = document.getElementById('continue_panel');

            console.log(`Site selector changed to: ${siteName}`);
            console.log(`Site data:`, site);
            console.log(`Pending actions:`, site?.pending_actions);

            // Always hide the continue panel first
            continuePanel.style.display = 'none';

            // Only show it if there are actually pending actions
            if (site && site.pending_actions > 0) {
                continuePanel.style.display = 'block';
                console.log('Continue panel shown - pending actions found');
            } else {
                console.log('Continue panel hidden - no pending actions');
            }

            // Clear file inputs when switching sites
            clearFileInputs();
        });

        // Clear file inputs and displays
        function clearFileInputs() {
            // Clear GSC file
            const gscInput = document.getElementById('gsc_file_input');
            const gscDisplay = document.getElementById('gsc_file_name');
            if (gscInput) {
                gscInput.value = '';
            }
            if (gscDisplay) {
                gscDisplay.textContent = '';
                gscDisplay.style.display = 'none';
            }

            // Clear GA4 file
            const ga4Input = document.getElementById('ga4_file_input');
            const ga4Display = document.getElementById('ga4_file_name');
            if (ga4Input) {
                ga4Input.value = '';
            }
            if (ga4Display) {
                ga4Display.textContent = '';
                ga4Display.style.display = 'none';
            }

            // Clear batch limit if shown
            const continueLimit = document.getElementById('continue_limit');
            if (continueLimit) {
                continueLimit.value = '';
            }

            // Clear results panel
            const resultsPanel = document.getElementById('results_panel');
            if (resultsPanel) {
                resultsPanel.classList.remove('show');
                resultsPanel.innerHTML = '';
            }

            // Reset execution mode to default (View Plan)
            const viewPlanOption = document.querySelector('.mode-option');
            if (viewPlanOption) {
                document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
                viewPlanOption.classList.add('selected');
                const radio = viewPlanOption.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;

                // Reset button text
                const executeBtn = document.getElementById('execute_btn');
                if (executeBtn) {
                    executeBtn.textContent = 'ü§ñ Start AI Analysis';
                }

                // Hide batch limit field
                const batchField = document.getElementById('batch_limit_field');
                if (batchField) {
                    batchField.style.display = 'none';
                }
            }

            // Reset force new plan checkbox
            const forceNewPlan = document.getElementById('force_new_plan');
            if (forceNewPlan) {
                forceNewPlan.checked = false;
            }
        }

        // Select Site from Dashboard
        function selectSiteFromDashboard(siteName) {
            switchView('execute');
            document.getElementById('exec_site_selector').value = siteName;
            document.getElementById('exec_site_selector').dispatchEvent(new Event('change'));
        }

        function selectSiteAndExecute(siteName) {
            selectSiteFromDashboard(siteName);
        }

        function viewSitePlan(siteName) {
            // Open the action plan modal directly
            openActionPlanModal(siteName);
        }

        // Execution Mode Selection
        function selectMode(mode) {
            document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            const radio = event.currentTarget.querySelector('input[type="radio"]');
            radio.checked = true;

            const batchField = document.getElementById('batch_limit_field');
            const btnText = document.getElementById('execute_btn');

            if (mode === 'execute_top_n') {
                batchField.style.display = 'block';
                btnText.textContent = 'üéØ Execute Batch';
            } else if (mode === 'execute_all') {
                batchField.style.display = 'none';
                btnText.textContent = 'üöÄ Execute All Actions';
            } else {
                batchField.style.display = 'none';
                btnText.textContent = 'ü§ñ Start AI Analysis';
            }
        }

        // File Selection
        function handleFileSelect(type) {
            const input = document.getElementById(type + '_file_input');
            const display = document.getElementById(type + '_file_name');

            if (input.files && input.files.length > 0) {
                const file = input.files[0];
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
                display.textContent = `‚úì ${file.name} (${fileSize} MB)`;
                display.style.display = 'block';
            } else {
                display.textContent = '';
                display.style.display = 'none';
            }
        }

        // Loading Overlay
        function showLoading(message, showProgress = false) {
            document.getElementById('loading_text').textContent = message;
            document.getElementById('loading_overlay').classList.add('show');

            const progressCounter = document.getElementById('progress_counter');
            const progressBarContainer = document.getElementById('progress_bar_container');

            if (showProgress) {
                progressCounter.style.display = 'block';
                progressBarContainer.style.display = 'block';
            } else {
                progressCounter.style.display = 'none';
                progressBarContainer.style.display = 'none';
            }
        }

        function updateProgress(current, total) {
            const progressCounter = document.getElementById('progress_counter');
            const progressBar = document.getElementById('progress_bar');

            progressCounter.textContent = `${current}/${total}`;
            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
        }

        function hideLoading() {
            document.getElementById('loading_overlay').classList.remove('show');
            // Reset progress
            document.getElementById('progress_counter').textContent = '0/0';
            document.getElementById('progress_bar').style.width = '0%';
        }

        // =================================================================
        // ACTION PLAN MODAL FUNCTIONS
        // =================================================================

        let currentPlanData = [];
        let selectedActionIds = new Set();
        let showPendingOnly = false;
        let currentActionPlanSiteName = null;  // Store site name for execution

        async function openActionPlanModal(siteName) {
            try {
                currentActionPlanSiteName = siteName;  // Save site name for later execution
                showLoading('Loading action plan...');

                const response = await fetch(`${API_BASE}/plan/${siteName}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load action plan');
                }

                currentPlanData = data.actions || [];
                selectedActionIds.clear();

                document.getElementById('action_plan_modal_title').textContent = `Action Plan - ${siteName}`;
                renderActionPlan();

                document.getElementById('action_plan_modal').classList.add('show');
                hideLoading();
            } catch (error) {
                hideLoading();
                showToast('Failed to Load Plan', error.message, 'error');
            }
        }

        function renderActionPlan() {
            const container = document.getElementById('action_plan_list');
            const actionsToShow = showPendingOnly
                ? currentPlanData.filter(a => a.status !== 'completed')
                : currentPlanData;

            if (actionsToShow.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No actions to display</p>';
                return;
            }

            container.innerHTML = actionsToShow.map(action => {
                const isSelected = selectedActionIds.has(action.id);
                const isCompleted = action.status === 'completed';

                return `
                    <div class="action-item ${isSelected ? 'selected' : ''} ${isCompleted ? 'completed' : ''}" data-action-id="${action.id}">
                        <div class="action-item-header">
                            <input type="checkbox"
                                   class="action-checkbox"
                                   ${isCompleted ? 'disabled' : ''}
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleActionSelection('${action.id}')">
                            <div class="action-badges">
                                <span class="badge ${action.action_type}">${action.action_type.toUpperCase()}</span>
                                <span class="badge ${action.status || 'pending'}">${(action.status || 'pending').toUpperCase()}</span>
                            </div>
                            <span class="action-priority">Priority: ${action.priority_score?.toFixed(1) || 'N/A'}</span>
                        </div>
                        <div class="action-title">${action.title || 'Untitled'}</div>
                        ${action.url ? `<div class="action-url">${action.url}</div>` : ''}
                        <div class="action-details">${action.reasoning || 'No description available'}</div>
                        ${action.keywords && action.keywords.length > 0 ?
                            `<div class="action-keywords">Keywords: ${action.keywords.join(', ')}</div>` : ''}
                    </div>
                `;
            }).join('');

            updateSelectionCount();
        }

        function toggleActionSelection(actionId) {
            if (selectedActionIds.has(actionId)) {
                selectedActionIds.delete(actionId);
            } else {
                selectedActionIds.add(actionId);
            }
            renderActionPlan();
        }

        function selectAllActions() {
            currentPlanData.forEach(action => {
                if (action.status !== 'completed') {
                    selectedActionIds.add(action.id);
                }
            });
            renderActionPlan();
        }

        function deselectAllActions() {
            selectedActionIds.clear();
            renderActionPlan();
        }

        function togglePendingOnly() {
            showPendingOnly = !showPendingOnly;
            document.getElementById('pending_only_btn').textContent =
                showPendingOnly ? 'Show All' : 'Show Pending Only';
            renderActionPlan();
        }

        function updateSelectionCount() {
            document.getElementById('selection_count').textContent =
                `${selectedActionIds.size} selected`;
            document.getElementById('execute_selected_btn').disabled = selectedActionIds.size === 0;
            document.getElementById('delete_selected_btn').disabled = selectedActionIds.size === 0;
        }

        async function deleteSelectedActions() {
            if (selectedActionIds.size === 0) {
                showToast('No Selection', 'Please select at least one action to delete', 'warning');
                return;
            }

            const count = selectedActionIds.size;
            if (!confirm(`‚ö†Ô∏è Delete ${count} selected action${count > 1 ? 's' : ''}?\n\nThis CANNOT be undone!`)) {
                return;
            }

            const siteName = document.getElementById('action_plan_modal_title').textContent.replace('Action Plan - ', '');
            showLoading(`Deleting ${count} action${count > 1 ? 's' : ''}...`);

            try {
                // Use batch delete endpoint to avoid race conditions
                const response = await fetch(`${API_BASE}/delete-actions-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        site_name: siteName,
                        action_ids: Array.from(selectedActionIds)
                    })
                });

                const data = await response.json();
                hideLoading();

                if (!response.ok || !data.success) {
                    showToast('Delete Failed', data.error || 'Unknown error', 'error');
                    return;
                }

                // Show success toast
                showToast('Actions Deleted', `Successfully deleted ${data.deleted_count} action${data.deleted_count > 1 ? 's' : ''}`, 'success');

                // Reload the action plan to update the list
                currentPlanData = currentPlanData.filter(a => !selectedActionIds.has(a.id));
                selectedActionIds.clear();

                // Re-render the action plan or close if empty
                if (currentPlanData.length === 0) {
                    closeActionPlanModal();
                    showToast('Action Plan Empty', 'All actions have been deleted', 'info');
                } else {
                    renderActionPlan();
                }

                // Refresh dashboard in the background
                await loadSites();
                renderDashboard();

            } catch (error) {
                hideLoading();
                showToast('Delete Failed', error.message, 'error');
            }
        }

        function closeActionPlanModal() {
            document.getElementById('action_plan_modal').classList.remove('show');
        }

        // =================================================================
        // CONFIRMATION MODAL FUNCTIONS
        // =================================================================

        let actionsToExecute = [];
        let executionCallback = null;

        function showConfirmationModal(actions, callback) {
            actionsToExecute = [...actions];
            executionCallback = callback;

            document.getElementById('confirm_count').textContent = actionsToExecute.length;

            const container = document.getElementById('confirmation_list');
            container.innerHTML = actionsToExecute.map((action, index) => `
                <div class="confirmation-item" data-action-id="${action.id}">
                    <div class="confirmation-item-number">${index + 1}.</div>
                    <div class="confirmation-item-content">
                        <div><span class="badge ${action.action_type}">${action.action_type.toUpperCase()}</span> ${action.title || 'Untitled'}</div>
                        ${action.url ? `<div style="font-size:12px;color:#666;margin-top:4px;">${action.url}</div>` : ''}
                    </div>
                    <button class="confirmation-item-remove" onclick="removeFromConfirmation('${action.id}')">‚úï</button>
                </div>
            `).join('');

            updateConfirmationSummary();
            document.getElementById('confirmation_modal').classList.add('show');
        }

        function removeFromConfirmation(actionId) {
            actionsToExecute = actionsToExecute.filter(a => a.id !== actionId);
            showConfirmationModal(actionsToExecute, executionCallback);

            if (actionsToExecute.length === 0) {
                closeConfirmationModal();
            }
        }

        function updateConfirmationSummary() {
            const creates = actionsToExecute.filter(a => a.action_type === 'create').length;
            const updates = actionsToExecute.filter(a => a.action_type === 'update').length;
            const redirects = actionsToExecute.filter(a => a.action_type === 'redirect_301').length;
            const deletes = actionsToExecute.filter(a => a.action_type === 'delete').length;

            const parts = [];
            if (creates > 0) parts.push(`${creates} create${creates > 1 ? 's' : ''}`);
            if (updates > 0) parts.push(`${updates} update${updates > 1 ? 's' : ''}`);
            if (redirects > 0) parts.push(`${redirects} redirect${redirects > 1 ? 's' : ''}`);
            if (deletes > 0) parts.push(`${deletes} delete${deletes > 1 ? 's' : ''}`);

            document.getElementById('confirmation_summary').textContent =
                `Total: ${actionsToExecute.length} action${actionsToExecute.length > 1 ? 's' : ''} (${parts.join(', ')})`;
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation_modal').classList.remove('show');
            actionsToExecute = [];
            executionCallback = null;
        }

        function confirmExecution() {
            console.log('=== confirmExecution CALLED ===');
            console.log('actionsToExecute:', actionsToExecute);
            console.log('executionCallback exists:', !!executionCallback);

            // CRITICAL: Save callback and actions BEFORE closeConfirmationModal() clears them!
            const callback = executionCallback;
            const actions = [...actionsToExecute];

            closeConfirmationModal();

            if (callback && actions.length > 0) {
                console.log('Calling executionCallback with', actions.length, 'actions');
                callback(actions);
            } else {
                console.log('NOT calling executionCallback - callback:', !!callback, 'actions:', actions.length);
            }
        }

        // =================================================================
        // EXECUTE SELECTED ACTIONS
        // =================================================================

        function executeSelectedActions() {
            console.log('=== executeSelectedActions CALLED ===');
            console.log('selectedActionIds:', selectedActionIds);

            if (selectedActionIds.size === 0) {
                console.log('No actions selected, showing warning');
                showToast('No Selection', 'Please select at least one action to execute', 'warning');
                return;
            }

            const selectedActions = currentPlanData.filter(a => selectedActionIds.has(a.id));
            console.log('selectedActions:', selectedActions);

            // Show confirmation modal first
            console.log('Showing confirmation modal');
            showConfirmationModal(selectedActions, async (confirmedActions) => {
                console.log('Confirmation modal callback triggered with actions:', confirmedActions);
                closeActionPlanModal();
                // Small delay to ensure modal closes before loading overlay shows
                await new Promise(resolve => setTimeout(resolve, 100));
                console.log('Starting executeActionsSequentially');
                await executeActionsSequentially(confirmedActions);
            });
        }

        async function executeActionsSequentially(actions) {
            console.log('=== executeActionsSequentially START ===');
            console.log('Actions to execute:', actions);

            // Use stored site name from action plan modal, fallback to selector
            const siteName = currentActionPlanSiteName || document.getElementById('exec_site_selector').value;
            console.log('Site name:', siteName);
            console.log('Source: currentActionPlanSiteName =', currentActionPlanSiteName);

            if (!siteName) {
                hideLoading();
                showToast('Error', 'No site selected. Please try again.', 'error');
                return;
            }

            console.log('Calling showLoading...');
            showLoading('Executing actions...', true);
            let completed = 0;
            let errors = [];
            console.log('showLoading called, starting execution loop');

            // Update progress immediately to show we're starting
            updateProgress(0, actions.length);
            document.getElementById('loading_text').textContent = 
                `Starting execution of ${actions.length} actions...`;

            for (const action of actions) {
                try {
                    // Update progress before each action
                    updateProgress(completed, actions.length);
                    document.getElementById('loading_text').textContent =
                        `[${completed + 1}/${actions.length}] Executing: ${action.title || action.url || 'Untitled'}`;

                    console.log(`Executing action ${completed + 1}/${actions.length}: ${action.title || action.url}`);

                    // Build actions map for fallback (in case state is missing redirect_target)
                    const actionsMap = {};
                    const actionData = {
                        id: action.id,
                        action_type: action.action_type,
                        url: action.url,
                        title: action.title,
                        keywords: action.keywords,
                        reasoning: action.reasoning
                    };
                    // Include redirect_target if it exists (even if empty, so backend can use AI fallback)
                    if (action.redirect_target !== undefined) {
                        actionData.redirect_target = action.redirect_target || '';
                    }
                    actionsMap[action.id] = actionData;
                    
                    // Debug logging for redirect actions
                    if (action.action_type === 'redirect_301') {
                        console.log(`Redirect action ${action.id}:`, {
                            url: action.url,
                            redirect_target: action.redirect_target,
                            has_redirect_target: !!action.redirect_target
                        });
                    }

                    // Check if image generation is enabled
                    const generateImages = document.getElementById('generate_images_toggle')?.checked || false;
                    
                    const response = await fetch(`${API_BASE}/execute-selected`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            site_name: siteName,
                            action_ids: [action.id],
                            actions: actionsMap,  // Send full action data as fallback
                            generate_images: generateImages  // Pass image generation flag
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || data.results?.[0]?.error) {
                        errors.push({
                            action: action.title || action.url,
                            error: data.results?.[0]?.error || data.error || 'Unknown error'
                        });
                        console.error(`Action failed: ${action.title || action.url}`, data.results?.[0]?.error || data.error);
                    } else {
                        console.log(`Action completed successfully: ${action.title || action.url}`);
                    }

                    completed++;

                    // Update progress after completion
                    updateProgress(completed, actions.length);

                    // Rate limiting: 2 seconds between actions
                    if (completed < actions.length) {
                        document.getElementById('loading_text').textContent = 
                            `Waiting 2 seconds before next action...`;
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }

                } catch (error) {
                    errors.push({
                        action: action.title || action.url,
                        error: error.message
                    });
                    completed++;
                    console.error(`Action error: ${action.title || action.url}`, error);
                    
                    // Update progress even on error
                    updateProgress(completed, actions.length);
                }
            }

            hideLoading();

            // Show results with toast
            if (errors.length > 0) {
                showToast(
                    'Execution Complete with Errors',
                    `Completed ${completed - errors.length} of ${actions.length} actions. ${errors.length} failed.`,
                    'warning',
                    6000
                );
                // Still show alert for detailed errors
                const errorMsg = errors.map(e => `‚Ä¢ ${e.action}: ${e.error}`).join('\n');
                alert(`‚ö†Ô∏è Errors occurred:\n\n${errorMsg}`);
            } else {
                showToast(
                    'Execution Complete',
                    `Successfully executed all ${actions.length} actions!`,
                    'success',
                    5000
                );
            }

            // Refresh sites data and dashboard
            await loadSites();
            renderDashboard();
        }

        // Continue Execution
        async function continueExecution() {
            const siteName = document.getElementById('exec_site_selector').value;
            if (!siteName) {
                showToast('No Site Selected', 'Please select a site first', 'warning');
                return;
            }

            const limit = document.getElementById('continue_limit').value;
            const confirmMsg = limit
                ? `Execute ${limit} action(s) for ${siteName}?`
                : `Execute ALL pending actions for ${siteName}?`;

            if (!confirm(confirmMsg)) return;

            await runExecutionLoop(siteName, limit ? parseInt(limit) : null);
        }

        // View Current Plan
        async function viewCurrentPlan() {
            const siteName = document.getElementById('exec_site_selector').value;
            if (!siteName) {
                showToast('No Site Selected', 'Please select a site first', 'warning');
                return;
            }

            // Open the action plan modal instead of showing inline results
            await openActionPlanModal(siteName);
        }

        // Delete Current Plan
        async function deleteCurrentPlan() {
            const siteName = document.getElementById('exec_site_selector').value;
            if (!siteName) {
                showToast('No Site Selected', 'Please select a site first', 'warning');
                return;
            }

            if (!confirm('‚ö†Ô∏è Delete all saved data for ' + siteName + '?\n\nThis will permanently remove the action plan and cannot be undone!')) {
                return;
            }

            showLoading('Deleting action plan...');

            try {
                const response = await fetch(`${API_BASE}/clear-plan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({site_name: siteName})
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                // Clear UI elements immediately
                document.getElementById('continue_panel').style.display = 'none';

                const resultsPanel = document.getElementById('results_panel');
                if (resultsPanel) {
                    resultsPanel.classList.remove('show');
                    resultsPanel.innerHTML = '';
                }

                // Close any open modals
                closeActionPlanModal();

                // Reload sites data and refresh - MUST complete before triggering change event
                await loadSites();
                
                // After loading sites, manually update the deleted site's data to reflect zero actions
                // This ensures the UI updates immediately even if backend has slight delay
                const siteIndex = sitesData.findIndex(s => s.name === siteName);
                if (siteIndex !== -1) {
                    sitesData[siteIndex].pending_actions = 0;
                    sitesData[siteIndex].total_actions = 0;
                    sitesData[siteIndex].completed_actions = 0;
                }
                
                // Re-populate site selectors with updated data
                populateSiteSelectors();
                
                // Re-render dashboard with updated site data
                renderDashboard();

                // Now refresh the continue panel state after data is loaded
                const siteSelector = document.getElementById('exec_site_selector');
                if (siteSelector && siteSelector.value === siteName) {
                    // Manually hide the continue panel since the site no longer has pending actions
                    const continuePanel = document.getElementById('continue_panel');
                    if (continuePanel) {
                        continuePanel.style.display = 'none';
                    }

                    // Dispatch change event to update UI properly
                    siteSelector.dispatchEvent(new Event('change'));
                }

                hideLoading();

                // Show success toast
                showToast('Plan Deleted', `Action plan for ${siteName} has been removed. You can now create a new analysis.`, 'success')

            } catch (error) {
                hideLoading();
                showToast('Delete Failed', error.message, 'error');
            }
        }

        // Show Plan Results
        function showPlanResults(data) {
            console.log('showPlanResults called with data:', data);
            console.log('Data keys:', Object.keys(data));
            console.log('Actions length:', data.actions ? data.actions.length : 'undefined');
            console.log('Stats:', data.stats);
            
            const panel = document.getElementById('results_panel');
            panel.innerHTML = `
                <div class="results-header">
                    <h2>üìã Current Action Plan</h2>
                    <p>Site: ${data.site}</p>
                </div>
                <div class="results-body">
                    <div class="site-stats" style="margin-bottom: 24px;">
                        <div class="stat-box">
                            <div class="stat-value">${data.stats.total_actions || 0}</div>
                            <div class="stat-label">Total Actions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.stats.completed || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.stats.pending || 0}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    <h3 style="margin-bottom: 16px;">Top 20 Actions</h3>
                    ${data.actions && data.actions.length > 0 ? data.actions.slice(0, 20).map((action, i) => `
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <strong>${i + 1}. ${action.title || 'New Content'}</strong>
                                <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                    ${action.action_type.toUpperCase()}
                                </span>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${action.url || 'New content'}</div>
                            <div style="font-size: 13px; color: #333;">${action.reasoning}</div>
                        </div>
                    `).join('') : '<div style="text-align: center; padding: 40px; color: #666;">No actions found in the current plan.</div>'}
                </div>
            `;
            panel.classList.add('show');
        }

        // Run Pipeline (main execution)
        async function runPipeline() {
            const siteName = document.getElementById('exec_site_selector').value;
            const gscFile = document.getElementById('gsc_file_input').files[0];
            const ga4File = document.getElementById('ga4_file_input').files[0];
            const mode = document.querySelector('input[name="exec_mode"]:checked').value;
            const forceNew = document.getElementById('force_new_plan').checked;

            // Validation
            if (!siteName) {
                showToast('No Site Selected', 'Please select a site to continue', 'warning');
                return;
            }

            if (!gscFile) {
                showToast('Missing Data', 'Please upload GSC data (required)', 'warning');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('site_name', siteName);
            formData.append('gsc_file', gscFile);
            if (ga4File) {
                formData.append('ga4_file', ga4File);
            }
            formData.append('execution_mode', mode);
            formData.append('force_new_plan', forceNew);

            if (mode === 'execute_top_n') {
                const limit = document.getElementById('exec_limit').value;
                formData.append('limit', limit);
            }

            // Confirm execution if not just viewing plan
            if (mode !== 'view_plan') {
                const limit = mode === 'execute_top_n' ? document.getElementById('exec_limit').value : 'all';
                const msg = `Execute ${limit === 'all' ? 'ALL' : limit} actions for ${siteName}?\n\nThis will modify your WordPress site.`;
                if (!confirm(msg)) return;
            }

            // Execute
            if (mode !== 'view_plan') {
                // For execution, use the loop method
                showLoading('Analyzing and executing...');

                // First analyze to create plan
                try {
                    formData.set('execution_mode', 'view_plan');
                    const analyzeResp = await fetch(`${API_BASE}/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    const analyzeData = await analyzeResp.json();

                    if (!analyzeResp.ok) {
                        throw new Error(analyzeData.error || 'Analysis failed');
                    }

                    // Now execute
                    const limit = mode === 'execute_top_n' ? parseInt(document.getElementById('exec_limit').value) : null;
                    await runExecutionLoop(siteName, limit);

                } catch (error) {
                    hideLoading();
                    showToast('Execution Failed', error.message, 'error');
                }
            } else {
                // Just analyze
                showLoading('Running AI analysis...', true);

                try {
                    const response = await fetch(`${API_BASE}/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Analysis failed');
                    }

                    hideLoading();

                    // Refresh dashboard data in background
                    await loadSites();
                    renderDashboard();

                    // Show success toast
                    showToast(
                        'Analysis Complete',
                        `Created ${data.summary.total_actions || 0} actions (${data.summary.high_priority || 0} high priority)`,
                        'success',
                        5000
                    );

                    // Clear file inputs
                    clearFileInputs();

                    // Auto-open the action plan modal to show the results
                    setTimeout(async () => {
                        const siteName = data.site;
                        if (siteName) {
                            await openActionPlanModal(siteName);
                            // Switch to dashboard view so user can see the new site card
                            switchView('dashboard');
                        }
                    }, 500);

                } catch (error) {
                    hideLoading();
                    showToast('Analysis Failed', error.message, 'error');
                }
            }
        }

        // Show Analysis Results
        function showAnalysisResults(data) {
            const panel = document.getElementById('results_panel');

            panel.innerHTML = `
                <div class="results-header">
                    <h2>‚ú® AI Analysis Complete</h2>
                    <p>Site: ${data.site}</p>
                </div>
                <div class="results-body">
                    <div class="site-stats" style="margin-bottom: 24px;">
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.total_actions || 0}</div>
                            <div class="stat-label">Total Actions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.updates || 0}</div>
                            <div class="stat-label">Updates</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.creates || 0}</div>
                            <div class="stat-label">New Posts</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.redirects || 0}</div>
                            <div class="stat-label">Redirects</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.deletes || 0}</div>
                            <div class="stat-label">Deletes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.summary.high_priority || 0}</div>
                            <div class="stat-label">High Priority</div>
                        </div>
                    </div>

                    ${data.summary.total_urls_analyzed ? `
                        <div class="alert alert-success" style="margin-bottom: 24px; background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 16px;">
                            <h4 style="margin-bottom: 8px; color: #0c4a6e;">üìä Analysis Transparency</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 12px;">
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: #0369a1;">${data.summary.total_urls_analyzed}</div>
                                    <div style="font-size: 13px; color: #64748b;">Total URLs Analyzed</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: #0369a1;">${data.summary.analysis_coverage_percent}%</div>
                                    <div style="font-size: 13px; color: #64748b;">Require Action</div>
                                </div>
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${data.summary.urls_not_requiring_action}</div>
                                    <div style="font-size: 13px; color: #64748b;">Performing Well</div>
                                </div>
                            </div>
                            <p style="margin-top: 12px; margin-bottom: 0; font-size: 13px; color: #475569;">
                                <strong>Why others weren't flagged:</strong> Good intent matching, recent content updates, no cannibalization issues, stable rankings, and adequate user engagement.
                            </p>
                        </div>
                    ` : ''}

                    ${data.niche_insights ? `
                        <div class="alert alert-info" style="margin-bottom: 24px;">
                            <h4 style="margin-bottom: 12px;">üîç Niche Intelligence</h4>
                            <p><strong>Summary:</strong> ${data.niche_insights.summary}</p>
                            <h5 style="margin-top: 16px; margin-bottom: 8px;">üìà Top Trends:</h5>
                            <ul style="margin-left: 20px;">
                                ${data.niche_insights.trends.slice(0, 3).map(t => `<li>${t}</li>`).join('')}
                            </ul>
                            <h5 style="margin-top: 16px; margin-bottom: 8px;">üí° Top Opportunities:</h5>
                            <ul style="margin-left: 20px;">
                                ${data.niche_insights.opportunities.slice(0, 3).map(o => `<li>${o}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <h3 style="margin-bottom: 16px;">üéØ Top Priority Actions</h3>
                    ${data.action_plan.slice(0, 15).map((action, i) => `
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <strong>${i + 1}. ${action.title || 'New Content'}</strong>
                                <div>
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 8px;">
                                        ${action.action_type.toUpperCase()}
                                    </span>
                                    <span style="background: #ffc107; color: black; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${action.priority_score.toFixed(1)}
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${action.url || 'New content'}</div>
                            <div style="font-size: 13px; color: #333;">${action.reasoning}</div>
                        </div>
                    `).join('')}

                    <div class="alert alert-success" style="margin-top: 24px;">
                        ‚úÖ Action plan saved! Switch to the Execute tab and click "Continue Execution" to start processing these actions.
                    </div>
                </div>
            `;
            panel.classList.add('show');
        }

        // Execution Loop (for continue execution)
        async function runExecutionLoop(siteName, limit) {
            // Determine total for progress bar
            const totalActions = limit || 'all';
            showLoading(limit ? `Executing ${limit} actions...` : 'Executing all actions...', true);

            const completedActions = [];
            const errors = [];
            let actionCount = 0;
            let hasMore = true;

            try {
                while (hasMore) {
                    if (limit && actionCount >= limit) break;

                    const response = await fetch(`${API_BASE}/execute-next`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({site_name: siteName})
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    if (data.status === 'complete') break;

                    if (data.status === 'action_executed') {
                        actionCount++;

                        // Update progress
                        const total = limit || data.stats.total_actions;
                        const current = limit ? actionCount : data.stats.completed;
                        updateProgress(current, total);

                        const progressMsg = limit
                            ? `Executing action ${actionCount} of ${limit}...`
                            : `Executing action ${data.stats.completed} of ${data.stats.total_actions}...`;
                        document.getElementById('loading_text').textContent = progressMsg;

                        const result = data.result;
                        if (result.success) {
                            completedActions.push(result);
                        } else {
                            errors.push(result);
                        }

                        hasMore = data.has_more;
                    }
                }

                // Show results
                showExecutionResults({
                    site: siteName,
                    total: actionCount,
                    successful: completedActions.length,
                    failed: errors.length,
                    completedActions,
                    errors
                });

                // Reload dashboard and refresh
                await loadSites();
                renderDashboard();
                clearFileInputs(); // Clear for next run
                hideLoading();

            } catch (error) {
                hideLoading();
                showToast('Execution Error', error.message, 'error');
            }
        }

        // Show Execution Results
        function showExecutionResults(data) {
            const panel = document.getElementById('results_panel');
            const successRate = data.total > 0 ? Math.round((data.successful / data.total) * 100) : 0;

            panel.innerHTML = `
                <div class="results-header">
                    <h2>‚úÖ Execution Complete</h2>
                    <p>Site: ${data.site}</p>
                </div>
                <div class="results-body">
                    <div class="${data.failed > 0 ? 'alert-error' : 'alert-success'} alert">
                        <strong>${data.failed > 0 ? '‚ö†Ô∏è' : '‚úÖ'} Results:</strong>
                        ${data.total} total, ${data.successful} successful, ${data.failed} failed (${successRate}% success rate)
                    </div>

                    ${data.completedActions.length > 0 ? `
                        <h3 style="margin-bottom: 16px;">Completed Actions</h3>
                        ${data.completedActions.map((action, i) => `
                            <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #4caf50;">
                                <strong>${i + 1}. ${action.action_type.toUpperCase()}</strong><br>
                                <a href="${action.url}" target="_blank" style="color: #1976d2;">${action.url}</a><br>
                                ${action.post_id ? `Post ID: ${action.post_id}` : ''}
                            </div>
                        `).join('')}
                    ` : ''}

                    ${data.errors.length > 0 ? `
                        <h3 style="margin-bottom: 16px; margin-top: 24px;">Errors</h3>
                        ${data.errors.map((error, i) => `
                            <div style="background: #ffebee; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #f44336;">
                                <strong>${i + 1}. ${error.action_type.toUpperCase()}</strong><br>
                                ${error.url}<br>
                                <code style="font-size: 12px;">${error.error}</code>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
            `;
            panel.classList.add('show');
        }

        // =================================================================
        // QUICK CREATE FUNCTIONS
        // =================================================================

        let quickCreateFormCount = 0;

        function addQuickCreateForm() {
            const container = document.getElementById('quick_create_forms');
            const formId = `quick_create_form_${quickCreateFormCount++}`;

            const formDiv = document.createElement('div');
            formDiv.id = formId;
            formDiv.style.cssText = 'border: 2px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #f8f9fa;';

            formDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <strong>Post ${quickCreateFormCount}</strong>
                    ${quickCreateFormCount > 1 ? `<button type="button" class="btn-secondary" onclick="removeQuickCreateForm('${formId}')" style="padding: 4px 12px; font-size: 12px;">Remove</button>` : ''}
                </div>
                <div class="form-group">
                    <label>Topic / Title</label>
                    <input type="text" class="form-control quick-create-title" placeholder="e.g., Best Camera Settings for Portraits">
                </div>
                <div class="form-group">
                    <label>Keywords (comma-separated)</label>
                    <input type="text" class="form-control quick-create-keywords" placeholder="e.g., camera settings, photography, portraits">
                </div>
            `;

            container.appendChild(formDiv);
        }

        function removeQuickCreateForm(formId) {
            document.getElementById(formId)?.remove();
        }

        async function submitQuickCreate() {
            const siteName = document.getElementById('quick_create_site').value;
            if (!siteName) {
                showToast('No Site Selected', 'Please select a site first', 'warning');
                return;
            }

            // Gather all post data
            const forms = document.querySelectorAll('#quick_create_forms > div');
            const posts = [];

            forms.forEach((form, index) => {
                const title = form.querySelector('.quick-create-title').value.trim();
                const keywords = form.querySelector('.quick-create-keywords').value.trim();

                if (title) {
                    posts.push({ title, keywords });
                }
            });

            if (posts.length === 0) {
                showToast('No Content', 'Please enter at least one post title', 'warning');
                return;
            }

            if (posts.length > 10) {
                showToast('Too Many Posts', 'Maximum 10 posts at a time', 'warning');
                return;
            }

            // Show confirmation modal
            const confirmActions = posts.map((post, i) => ({
                id: `quick_${i}`,
                action_type: 'create',
                title: post.title,
                keywords: post.keywords
            }));

            showConfirmationModal(confirmActions, async (confirmedPosts) => {
                await executeQuickCreate(siteName, confirmedPosts);
            });
        }

        async function executeQuickCreate(siteName, posts) {
            showLoading('Creating posts...', true);
            let completed = 0;
            let errors = [];
            let successfulPosts = [];

            for (const post of posts) {
                try {
                    updateProgress(completed, posts.length);
                    document.getElementById('loading_text').textContent =
                        `Creating: ${post.title}`;

                    const response = await fetch(`${API_BASE}/quick-create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            site_name: siteName,
                            title: post.title,
                            keywords: post.keywords
                        })
                    });

                    const data = await response.json();

                    if (!response.ok || data.error) {
                        errors.push({
                            title: post.title,
                            error: data.error || 'Unknown error'
                        });
                    } else if (data.skipped) {
                        errors.push({
                            title: post.title,
                            error: data.reason || 'Skipped'
                        });
                    } else {
                        successfulPosts.push({
                            title: post.title,
                            url: data.url
                        });
                    }

                    completed++;

                    // Rate limiting: 2 seconds between posts
                    if (completed < posts.length) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }

                } catch (error) {
                    errors.push({
                        title: post.title,
                        error: error.message
                    });
                    completed++;
                }
            }

            hideLoading();

            // Show success toast
            if (errors.length === 0) {
                showToast(
                    'Posts Created!',
                    `Successfully created ${successfulPosts.length} post${successfulPosts.length > 1 ? 's' : ''}`,
                    'success',
                    5000
                );
            } else {
                showToast(
                    'Partial Success',
                    `Created ${successfulPosts.length} of ${posts.length} posts. ${errors.length} failed.`,
                    'warning',
                    6000
                );

                // Show detailed errors in alert
                const errorMsg = errors.map(e => `‚Ä¢ ${e.title}: ${e.error}`).join('\n');
                setTimeout(() => {
                    alert(`‚ö†Ô∏è Some posts failed:\n\n${errorMsg}`);
                }, 500);
            }

            // Clear forms and reload dashboard
            document.getElementById('quick_create_forms').innerHTML = '';
            quickCreateFormCount = 0;
            addQuickCreateForm();
            await loadSites();
            renderDashboard();
        }

        // =================================================================
        // SETTINGS FUNCTIONS
        // =================================================================

        function saveApiKey() {
            const apiKey = document.getElementById('settings_anthropic_key').value;
            const statusEl = document.getElementById('api_key_status');

            if (!apiKey) {
                statusEl.textContent = 'Please enter an API key';
                statusEl.className = 'settings-status error';
                statusEl.style.display = 'block';
                return;
            }

            // Save to localStorage
            localStorage.setItem('anthropic_api_key', apiKey);

            statusEl.textContent = '‚úÖ API key saved successfully! It will be used for future requests.';
            statusEl.className = 'settings-status success';
            statusEl.style.display = 'block';

            showToast('Settings Saved', 'API key has been saved to local storage', 'success');

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function exportAllStates() {
            fetch(`${API_BASE}/state/export`)
                .then(response => response.json())
                .then(data => {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `seo-states-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                    showToast('Export Complete', 'States downloaded successfully', 'success');
                })
                .catch(error => {
                    showToast('Export Failed', error.message, 'error');
                });
        }

        function viewAllStates() {
            fetch(`${API_BASE}/sites`)
                .then(response => response.json())
                .then(data => {
                    const summary = data.sites.map(site =>
                        `${site.name}: ${site.total_actions} total, ${site.completed_actions} completed, ${site.pending_actions} pending`
                    ).join('\n');
                    alert(`üìä Site States:\n\n${summary || 'No sites found'}`);
                })
                .catch(error => {
                    showToast('Failed to Load', error.message, 'error');
                });
        }

        function confirmClearAllStates() {
            if (confirm('‚ö†Ô∏è Warning: This will delete ALL saved action plans for ALL sites. This cannot be undone.\n\nAre you absolutely sure?')) {
                if (confirm('This is your last chance. Delete everything?')) {
                    clearAllStates();
                }
            }
        }

        async function clearAllStates() {
            try {
                const response = await fetch(`${API_BASE}/state/clear-all`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    showToast('States Cleared', 'All action plans have been deleted', 'success');
                    await loadSites();
                    renderDashboard();
                } else {
                    showToast('Clear Failed', data.error || 'Unknown error', 'error');
                }
            } catch (error) {
                showToast('Clear Failed', error.message, 'error');
            }
        }

        // Populate sites list in settings on view switch
        function populateSettingsSites() {
            const sitesList = document.getElementById('sites_list');
            if (!sitesList) return;

            if (sitesData.length === 0) {
                sitesList.innerHTML = '<div class="loading-placeholder">No sites configured yet</div>';
                return;
            }

            sitesList.innerHTML = sitesData.map(site => `
                <div class="site-config-item">
                    <div>
                        <div class="site-config-name">üåê ${site.name}</div>
                        <div class="site-config-status">‚úì Configured</div>
                    </div>
                </div>
            `).join('');
        }

        // Update switchView to populate settings when opened
        const originalSwitchView = switchView;
        switchView = function(viewName) {
            originalSwitchView(viewName);
            if (viewName === 'settings') {
                populateSettingsSites();
                // Load saved API key if exists
                const savedKey = localStorage.getItem('anthropic_api_key');
                if (savedKey) {
                    document.getElementById('settings_anthropic_key').value = savedKey;
                }
            }
        };
    </script>
</body>
</html>
