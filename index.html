<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Magic SEO - AI Portfolio Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        h1 .emoji {
            font-size: 36px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .form-section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .file-upload {
            position: relative;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }
        
        .file-label {
            color: #666;
            font-size: 14px;
        }
        
        .file-name {
            color: #667eea;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .radio-option {
            flex: 1;
        }
        
        .radio-option input[type="radio"] {
            display: none;
        }
        
        .radio-option label {
            display: block;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .radio-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: #f5f7ff;
            color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-execute {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-execute:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            margin-top: 30px;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
        }
        
        .results-body {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 0 0 8px 8px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }
        
        .niche-insights {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .niche-insights h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .insight-list {
            list-style: none;
        }
        
        .insight-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .insight-list li:before {
            content: "✨";
            margin-right: 10px;
        }
        
        .action-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f5f7ff;
        }
        
        .priority-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .priority-high {
            background: #ffebee;
            color: #c62828;
        }
        
        .priority-medium {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .priority-low {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .action-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-update { background: #e3f2fd; color: #1976d2; }
        .action-create { background: #e8f5e9; color: #388e3c; }
        .action-delete { background: #ffebee; color: #d32f2f; }
        .action-redirect { background: #fff3e0; color: #f57c00; }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-top: 20px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef6c00;
            margin-bottom: 25px;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="emoji">🎯</span> WordPress Magic SEO <span class="badge">v3.0 AI</span></h1>
            <p class="subtitle">AI-Powered Multi-Site Portfolio Manager with Niche Intelligence</p>
        </header>
        
        <div class="warning">
            ⚠️ <strong>Test Mode:</strong> Start with "Analyze Only" to review the AI-generated plan before execution. Use limit=1 for safe testing.
        </div>
        
        <form id="seoForm">
            <!-- Site Selection -->
            <div class="form-section">
                <div class="section-title">
                    <span>🏢</span> Site Configuration
                </div>
                
                <div class="form-group">
                    <label for="site_selector">Select Pre-Configured Site (Optional)</label>
                    <select id="site_selector" onchange="handleSiteSelect()">
                        <option value="">-- Manual Configuration --</option>
                    </select>
                    <div class="help-text">Or configure manually below</div>
                </div>
                
                <div id="manualConfig">
                    <div class="form-group">
                        <label for="site_url">WordPress Site URL *</label>
                        <input type="text" id="site_url" name="site_url" placeholder="https://yoursite.com">
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="username">WordPress Username *</label>
                            <input type="text" id="username" name="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="app_password">Application Password *</label>
                            <input type="password" id="app_password" name="application_password">
                            <div class="help-text">WP: Users → Profile → Application Passwords</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Upload -->
            <div class="form-section">
                <div class="section-title">
                    <span>📊</span> Data Input (GSC + GA4)
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Google Search Console Data *</label>
                        <div class="file-upload">
                            <input type="file" id="gsc_file" name="gsc_file" accept=".csv,.xlsx,.xls" required onchange="updateFileName('gsc_file')">
                            <div class="file-label">📁 Click to upload GSC CSV/Excel</div>
                            <div class="file-name" id="gsc_file_name"></div>
                        </div>
                        <div class="help-text">GSC → Performance → Export (12 months)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Google Analytics 4 Data (Optional)</label>
                        <div class="file-upload">
                            <input type="file" id="ga4_file" name="ga4_file" accept=".csv,.xlsx,.xls" onchange="updateFileName('ga4_file')">
                            <div class="file-label">📁 Click to upload GA4 CSV/Excel</div>
                            <div class="file-name" id="ga4_file_name"></div>
                        </div>
                        <div class="help-text">GA4 → Engagement → Export</div>
                    </div>
                </div>
            </div>
            
            <!-- Affiliate Link Management -->
            <div class="form-section">
                <div class="section-title">
                    <span>🔗</span> Affiliate Link Management (Optional)
                </div>

                <div class="warning" style="background: #e3f2fd; color: #1565c0; border-left-color: #1565c0; margin-bottom: 20px;">
                    ℹ️ <strong>How Affiliate Links Work:</strong><br>
                    Affiliate links will be intelligently added to content that is <strong>CREATED or UPDATED</strong> during this pipeline run. Links are matched based on keywords and product relevance. The AI will add 2-5 relevant links per article where they naturally provide value to readers.
                </div>

                <div class="form-group">
                    <label>Input Method</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="affiliate_none" name="affiliate_mode" value="none" checked>
                            <label for="affiliate_none">
                                <strong>Skip</strong><br>
                                <small>No affiliate links</small>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="affiliate_csv" name="affiliate_mode" value="csv">
                            <label for="affiliate_csv">
                                <strong>📁 Upload CSV</strong><br>
                                <small>Bulk import</small>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="affiliate_manual" name="affiliate_mode" value="manual">
                            <label for="affiliate_manual">
                                <strong>✏️ Manual Entry</strong><br>
                                <small>Add individually</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- CSV Upload Section -->
                <div id="affiliate_csv_section" style="display: none; margin-top: 15px;">
                    <div class="form-group">
                        <label>Upload Affiliate Links CSV</label>
                        <div class="file-upload">
                            <input type="file" id="affiliate_csv_file" accept=".csv" onchange="updateFileName('affiliate_csv_file')">
                            <div class="file-label">📁 Click to upload CSV</div>
                            <div class="file-name" id="affiliate_csv_file_name"></div>
                        </div>
                        <div class="help-text">
                            CSV Format: url,brand,product_name,product_type,keywords(optional)<br>
                            Example: https://brand.com/product?aff=123,Traeger,Flatrock Griddle,outdoor griddle,griddle|cooking
                        </div>
                    </div>
                </div>
                
                <!-- Manual Entry Section -->
                <div id="affiliate_manual_section" style="display: none; margin-top: 15px;">
                    <div id="affiliate_links_container">
                        <div class="affiliate-link-entry" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                            <div class="row">
                                <div class="form-group">
                                    <label>Affiliate URL</label>
                                    <input type="text" class="affiliate-url" placeholder="https://brand.com/product?aff=123">
                                </div>
                                <div class="form-group">
                                    <label>Brand</label>
                                    <input type="text" class="affiliate-brand" placeholder="e.g., Traeger">
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Product Name</label>
                                    <input type="text" class="affiliate-product-name" placeholder="e.g., Flatrock Griddle">
                                </div>
                                <div class="form-group">
                                    <label>Product Type</label>
                                    <input type="text" class="affiliate-product-type" placeholder="e.g., outdoor griddle">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="addAffiliateRow()" style="background: #667eea; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        + Add Another Link
                    </button>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="enable_affiliate_updates" style="width: auto;">
                        <span>Enable AI-powered affiliate link insertion</span>
                    </label>
                    <div class="help-text">When enabled, the AI will intelligently add relevant affiliate links to articles being created or updated. Existing posts NOT in the action plan will not be modified. To update all existing content, use the "Bulk Update" button below.</div>
                </div>
            </div>
            
            <!-- Execution Mode -->
            <div class="form-section">
                <div class="section-title">
                    <span>⚙️</span> Execution Mode
                </div>

                <div class="warning" style="background: #fff3e0; color: #ef6c00; border-left-color: #ef6c00; margin-bottom: 20px;">
                    💡 <strong>Execution Modes Explained:</strong><br>
                    <strong>View Plan:</strong> Analyze your site and see recommended actions without making any changes.<br>
                    <strong>Execute Top N:</strong> Run a limited number of the highest-priority SEO improvements (creates, updates, or deletes).<br>
                    <strong>Execute All Planned Actions:</strong> Run all recommended SEO improvements based on your GSC data analysis.
                </div>

                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="mode_view" name="execution_mode" value="view_plan" checked>
                        <label for="mode_view">
                            <strong>📋 View Plan</strong><br>
                            <small>Analyze only (safe, no changes)</small>
                        </label>
                    </div>

                    <div class="radio-option">
                        <input type="radio" id="mode_top_n" name="execution_mode" value="execute_top_n">
                        <label for="mode_top_n">
                            <strong>🎯 Execute Top N</strong><br>
                            <small>Run N highest-priority actions</small>
                        </label>
                    </div>

                    <div class="radio-option">
                        <input type="radio" id="mode_all" name="execution_mode" value="execute_all">
                        <label for="mode_all">
                            <strong>🚀 Execute All Planned Actions</strong><br>
                            <small>Run all SEO improvements</small>
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="limit_field" style="margin-top: 15px; display: none;">
                    <label for="limit">Number of Actions to Execute</label>
                    <input type="number" id="limit" name="limit" value="5" min="1" placeholder="e.g., 5">
                    <div class="help-text">Only the top N highest-priority actions will be executed (creates, updates, or deletes based on GSC analysis)</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="form-section" style="background: #f0f4ff;">
                <div class="section-title">
                    <span>⚡</span> Quick Actions
                </div>

                <div class="warning" style="background: white; margin-bottom: 15px;">
                    ℹ️ Use this to update your existing articles with affiliate links without running the full SEO pipeline. Requires affiliate links to be uploaded above.
                </div>

                <button type="button" class="btn-secondary" onclick="showBulkUpdateModal()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; width: 100%;">
                    🔄 Bulk Update Existing Articles with Affiliate Links
                </button>
            </div>

            <!-- API Key -->
            <div class="form-section">
                <div class="section-title">
                    <span>🔑</span> AI Configuration
                </div>

                <div class="form-group">
                    <label for="anthropic_key">Anthropic API Key</label>
                    <input type="password" id="anthropic_key" name="anthropic_api_key" placeholder="sk-ant-api03-... (optional if set in Vercel)">
                    <div class="help-text">Get from console.anthropic.com - or set ANTHROPIC_API_KEY in Vercel</div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn-analyze" onclick="runPipeline()">
                    <span id="btn_text">🤖 Start AI Analysis</span>
                </button>
            </div>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText" style="color: #666; font-size: 16px;">Processing...</p>
        </div>
        
        <div class="error" id="error"></div>

        <div class="results" id="results"></div>
    </div>

    <!-- Bulk Update Modal -->
    <div id="bulkUpdateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔄 Bulk Update with Affiliate Links</h2>
                <button class="close-btn" onclick="closeBulkUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>This will update your existing WordPress articles with relevant affiliate links.</strong></p>

                <div class="form-group">
                    <label for="bulk_site_selector">Select Site</label>
                    <select id="bulk_site_selector">
                        <option value="">-- Select a site --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bulk_post_ids">WordPress Post IDs (comma-separated)</label>
                    <input type="text" id="bulk_post_ids" placeholder="e.g., 123, 456, 789">
                    <div class="help-text">Enter the post IDs you want to update. Leave blank to update recent posts.</div>
                </div>

                <div class="form-group">
                    <label for="bulk_limit">Max Posts to Update</label>
                    <input type="number" id="bulk_limit" value="10" min="1" max="50">
                    <div class="help-text">Limit the number of posts to update (recommended: start with 5-10)</div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="bulk_auto_publish" style="width: auto;" checked>
                        <span>Auto-publish changes</span>
                    </label>
                    <div class="help-text">If unchecked, changes will be saved as drafts for review</div>
                </div>

                <div class="warning" style="margin-top: 15px;">
                    ⚠️ This will modify your WordPress content. Make sure you have affiliate links uploaded for this site first.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBulkUpdateModal()">Cancel</button>
                <button class="btn-analyze" onclick="runBulkUpdate()">Start Bulk Update</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        // Load sites on page load
        window.addEventListener('DOMContentLoaded', loadSites);
        
        // Show/hide limit field based on execution mode
        document.querySelectorAll('input[name="execution_mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const limitField = document.getElementById('limit_field');
                limitField.style.display = this.value === 'execute_top_n' ? 'block' : 'none';
                
                // Update button text
                const btnText = document.getElementById('btn_text');
                if (this.value === 'view_plan') {
                    btnText.textContent = '🤖 Start AI Analysis';
                } else if (this.value === 'execute_top_n') {
                    btnText.textContent = '🎯 Execute Top N Actions';
                } else {
                    btnText.textContent = '🚀 Execute Full Pipeline';
                }
            });
        });
        
        // Show/hide affiliate sections based on mode
        document.querySelectorAll('input[name="affiliate_mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('affiliate_csv_section').style.display = 
                    this.value === 'csv' ? 'block' : 'none';
                document.getElementById('affiliate_manual_section').style.display = 
                    this.value === 'manual' ? 'block' : 'none';
            });
        });
        
        async function loadSites() {
            try {
                const response = await fetch(`${API_BASE}/sites`);
                if (response.ok) {
                    const data = await response.json();
                    const selector = document.getElementById('site_selector');
                    
                    data.sites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.name;
                        option.textContent = `${site.name} (${site.pending_actions} SEO actions pending)`;
                        selector.appendChild(option);

                        // Also populate bulk update modal
                        const bulkOption = document.createElement('option');
                        bulkOption.value = site.name;
                        bulkOption.textContent = site.name;
                        document.getElementById('bulk_site_selector').appendChild(bulkOption);
                    });
                }
            } catch (e) {
                console.log('Could not load sites:', e);
            }
        }
        
        function handleSiteSelect() {
            const selector = document.getElementById('site_selector');
            const manualConfig = document.getElementById('manualConfig');

            if (selector.value) {
                // Pre-configured site selected - hide manual config and clear values
                manualConfig.style.display = 'none';
                document.getElementById('site_url').value = '';
                document.getElementById('username').value = '';
                document.getElementById('app_password').value = '';
                document.getElementById('site_url').removeAttribute('required');
                document.getElementById('username').removeAttribute('required');
                document.getElementById('app_password').removeAttribute('required');
            } else {
                // Manual config
                manualConfig.style.display = 'block';
                document.getElementById('site_url').setAttribute('required', '');
                document.getElementById('username').setAttribute('required', '');
                document.getElementById('app_password').setAttribute('required', '');
            }
        }
        
        function updateFileName(inputId) {
            const input = document.getElementById(inputId);
            const nameDisplay = document.getElementById(inputId + '_name');
            if (input.files.length > 0) {
                nameDisplay.textContent = '✓ ' + input.files[0].name;
            }
        }
        
        function addAffiliateRow() {
            const container = document.getElementById('affiliate_links_container');
            const newRow = container.firstElementChild.cloneNode(true);
            // Clear all inputs
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            container.appendChild(newRow);
        }
        
        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loading').classList.add('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('results').classList.remove('show');
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = '❌ ' + message;
            errorDiv.classList.add('show');
            hideLoading();
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');

            const isExecution = data.status === 'execution_complete';
            const headerText = isExecution
                ? `${data.mode === 'ai_powered' ? 'AI-Powered' : 'Rule-Based'} Execution Complete`
                : `${data.mode === 'ai_powered' ? 'AI-Powered' : 'Rule-Based'} Analysis Complete`;

            let html = `
                <div class="results-header">
                    <h2>✨ ${headerText}</h2>
                    <p>Site: ${data.site}</p>
                </div>
                <div class="results-body">
            `;

            // Execution Stats (if execution mode)
            if (isExecution && data.stats) {
                html += `
                    <div style="background: ${data.stats.failed > 0 ? '#fff3e0' : '#e8f5e9'}; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid ${data.stats.failed > 0 ? '#ef6c00' : '#388e3c'};">
                        <h3 style="color: ${data.stats.failed > 0 ? '#ef6c00' : '#388e3c'}; margin-bottom: 10px;">
                            ${data.stats.failed > 0 ? '⚠️' : '✅'} Execution Results
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 14px;">
                            <div>
                                <strong>Total:</strong> ${data.stats.total_actions}
                            </div>
                            <div style="color: #388e3c;">
                                <strong>✓ Successful:</strong> ${data.stats.successful}
                            </div>
                            <div style="color: #d32f2f;">
                                <strong>✗ Failed:</strong> ${data.stats.failed}
                            </div>
                            <div>
                                <strong>Success Rate:</strong> ${data.stats.success_rate}
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                            <strong>${data.note}</strong>
                        </div>
                    </div>
                `;
            }

            // Plan Summary Stats (always show if available)
            if (data.summary) {
                html += `
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Actions Planned</div>
                            <div class="stat-value">${data.summary.total_actions || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Updates</div>
                            <div class="stat-value">${data.summary.updates || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">New Posts</div>
                            <div class="stat-value">${data.summary.creates || 0}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">High Priority</div>
                            <div class="stat-value">${data.summary.high_priority || 0}</div>
                        </div>
                    </div>
                `;
            }
            
            // Niche Insights
            if (data.niche_insights) {
                html += `
                    <div class="niche-insights">
                        <h3>🔍 Niche Intelligence</h3>
                        <p style="margin-bottom: 15px;"><strong>Summary:</strong> ${data.niche_insights.summary}</p>
                        
                        <h4 style="margin-top: 15px; color: #667eea;">📈 Top Trends</h4>
                        <ul class="insight-list">
                            ${data.niche_insights.trends.slice(0, 3).map(t => `<li>${t}</li>`).join('')}
                        </ul>
                        
                        <h4 style="margin-top: 15px; color: #667eea;">💡 Top Opportunities</h4>
                        <ul class="insight-list">
                            ${data.niche_insights.opportunities.slice(0, 3).map(o => `<li>${o}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Completed Actions
            if (data.completed_actions && data.completed_actions.length > 0) {
                const createsAndUpdates = data.completed_actions.filter(a =>
                    a.action === 'create' || a.action === 'update'
                ).length;

                html += `
                    <div style="background: #e8f5e9; border-left: 4px solid #388e3c; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #388e3c; margin-bottom: 15px;">✅ Completed Actions</h3>
                        ${createsAndUpdates > 0 ? `
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <strong>🔗 Affiliate Links:</strong> ${createsAndUpdates} articles were created/updated. Relevant affiliate links were automatically inserted where they add value.
                            </div>
                        ` : ''}
                        ${data.completed_actions.map((action, idx) => `
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                <strong>${idx + 1}. ${action.action.toUpperCase()}</strong><br>
                                <strong>URL:</strong> <a href="${action.url}" target="_blank" style="color: #1976d2;">${action.url}</a><br>
                                ${action.post_id ? `<strong>Post ID:</strong> ${action.post_id}<br>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Errors
            if (data.errors && data.errors.length > 0) {
                html += `
                    <div style="background: #ffebee; border-left: 4px solid #c62828; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #c62828; margin-bottom: 15px;">❌ Execution Errors</h3>
                        ${data.errors.map(err => `
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                <strong>Action:</strong> ${err.action}<br>
                                <strong>URL:</strong> ${err.url || 'N/A'}<br>
                                <strong>Error:</strong> <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${err.error}</code>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-radius: 6px;">
                            <strong>💡 Common fixes:</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                                <li>Check ANTHROPIC_API_KEY in Vercel environment variables</li>
                                <li>Verify your API key at console.anthropic.com</li>
                                <li>Try entering API key manually in the form above</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            // Action Plan
            if (data.action_plan && data.action_plan.length > 0) {
                html += `
                    <div class="action-table">
                        <h3 style="padding: 15px; background: white;">🎯 Top Priority Actions</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Type</th>
                                    <th>Title / URL</th>
                                    <th>Reasoning</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.action_plan.slice(0, 10).map(action => `
                                    <tr>
                                        <td>
                                            <span class="priority-badge ${getPriorityClass(action.priority_score)}">
                                                ${action.priority_score.toFixed(1)}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="action-badge action-${action.action_type}">
                                                ${action.action_type}
                                            </span>
                                        </td>
                                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                            <strong>${action.title || 'N/A'}</strong><br>
                                            <small style="color: #888;">${action.url || 'New content'}</small>
                                        </td>
                                        <td style="font-size: 13px;">${action.reasoning.substring(0, 150)}...</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
            hideLoading();
        }
        
        function getPriorityClass(score) {
            if (score >= 8) return 'priority-high';
            if (score >= 5) return 'priority-medium';
            return 'priority-low';
        }

        function showBulkUpdateModal() {
            const affiliateMode = document.querySelector('input[name="affiliate_mode"]:checked').value;

            if (affiliateMode === 'none') {
                alert('Please upload or add affiliate links first before using bulk update.');
                return;
            }

            document.getElementById('bulkUpdateModal').classList.add('show');
        }

        function closeBulkUpdateModal() {
            document.getElementById('bulkUpdateModal').classList.remove('show');
        }

        async function runBulkUpdate() {
            const siteName = document.getElementById('bulk_site_selector').value;
            const postIdsText = document.getElementById('bulk_post_ids').value;
            const limit = parseInt(document.getElementById('bulk_limit').value);
            const autoPublish = document.getElementById('bulk_auto_publish').checked;

            if (!siteName) {
                alert('Please select a site');
                return;
            }

            // Parse post IDs if provided
            let postIds = [];
            if (postIdsText.trim()) {
                postIds = postIdsText.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
                if (postIds.length === 0) {
                    alert('Please enter valid post IDs (numbers separated by commas)');
                    return;
                }
            }

            const confirmMsg = postIds.length > 0
                ? `Update ${postIds.length} specific posts with affiliate links?`
                : `Update up to ${limit} recent posts with affiliate links?`;

            if (!confirm(confirmMsg + '\n\nThis will modify your WordPress content. Continue?')) {
                return;
            }

            closeBulkUpdateModal();
            showLoading('Updating posts with affiliate links... This may take several minutes.');

            try {
                const requestBody = {
                    site_name: siteName,
                    auto_publish: autoPublish,
                    limit: limit
                };

                if (postIds.length > 0) {
                    requestBody.post_ids = postIds;
                }

                const response = await fetch(`${API_BASE}/affiliate/bulk-update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'Bulk update failed');
                }

                // Show results
                showBulkUpdateResults(data);
            } catch (error) {
                console.error('Bulk update error:', error);
                showError(error.message || 'An unknown error occurred during bulk update');
            }
        }

        function showBulkUpdateResults(data) {
            const resultsDiv = document.getElementById('results');

            const successful = data.results.filter(r => r.success).length;
            const failed = data.results.filter(r => !r.success).length;

            let html = `
                <div class="results-header">
                    <h2>✅ Bulk Update Complete</h2>
                    <p>Updated ${successful} out of ${data.total_posts} posts</p>
                </div>
                <div class="results-body">
                    <div style="background: ${failed > 0 ? '#fff3e0' : '#e8f5e9'}; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid ${failed > 0 ? '#ef6c00' : '#388e3c'};">
                        <h3 style="color: ${failed > 0 ? '#ef6c00' : '#388e3c'}; margin-bottom: 10px;">
                            ${failed > 0 ? '⚠️' : '✅'} Results Summary
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 14px;">
                            <div style="color: #388e3c;">
                                <strong>✓ Successful:</strong> ${successful}
                            </div>
                            <div style="color: #d32f2f;">
                                <strong>✗ Failed:</strong> ${failed}
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-bottom: 15px;">📝 Updated Posts</h3>
            `;

            data.results.forEach((result, idx) => {
                const statusColor = result.success ? '#388e3c' : '#d32f2f';
                const statusIcon = result.success ? '✅' : '❌';

                html += `
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${statusColor};">
                        <strong>${statusIcon} Post ID: ${result.post_id}</strong><br>
                        ${result.success ? `
                            <strong>Links Added:</strong> ${result.links_added ? result.links_added.length : 0}<br>
                            <strong>Links Removed:</strong> ${result.links_removed ? result.links_removed.length : 0}<br>
                            ${result.published ? '<span style="color: #388e3c;">✓ Published</span>' : '<span style="color: #ef6c00;">Saved as draft</span>'}
                        ` : `
                            <strong style="color: #d32f2f;">Error:</strong> ${result.error || 'Unknown error'}
                        `}
                    </div>
                `;
            });

            html += '</div>';

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
            hideLoading();
        }

        function extractSiteName(url) {
            // Extract domain from URL (e.g., 'https://phototipsguy.com' -> 'phototipsguy.com')
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.replace('www.', '');
            } catch (e) {
                // If URL parsing fails, try simple extraction
                return url.replace(/^https?:\/\/(www\.)?/, '').replace(/\/.*$/, '');
            }
        }

        async function runPipeline() {
            const form = document.getElementById('seoForm');
            const formData = new FormData(form);
            
            // Handle affiliate links first if configured
            const affiliateMode = document.querySelector('input[name="affiliate_mode"]:checked').value;
            const enableAffiliateUpdates = document.getElementById('enable_affiliate_updates').checked;
            
            if (affiliateMode !== 'none' && enableAffiliateUpdates) {
                const siteName = document.getElementById('site_selector').value || 
                                extractSiteName(document.getElementById('site_url').value);
                
                if (affiliateMode === 'csv') {
                    // Upload CSV
                    const csvFile = document.getElementById('affiliate_csv_file');
                    if (csvFile.files.length > 0) {
                        const affiliateFormData = new FormData();
                        affiliateFormData.append('site_name', siteName);
                        affiliateFormData.append('csv_file', csvFile.files[0]);
                        
                        try {
                            const response = await fetch(`${API_BASE}/affiliate/links/upload`, {
                                method: 'POST',
                                body: affiliateFormData
                            });
                            const result = await response.json();
                            console.log('Affiliate CSV upload result:', result);
                        } catch (e) {
                            console.error('Error uploading affiliate CSV:', e);
                        }
                    }
                } else if (affiliateMode === 'manual') {
                    // Add manual entries
                    const entries = document.querySelectorAll('.affiliate-link-entry');
                    for (const entry of entries) {
                        const url = entry.querySelector('.affiliate-url').value;
                        const brand = entry.querySelector('.affiliate-brand').value;
                        const productName = entry.querySelector('.affiliate-product-name').value;
                        const productType = entry.querySelector('.affiliate-product-type').value;
                        
                        if (url && brand && productName && productType) {
                            try {
                                const response = await fetch(`${API_BASE}/affiliate/links/add`, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                        site_name: siteName,
                                        url, brand, product_name: productName, product_type: productType
                                    })
                                });
                                const result = await response.json();
                                console.log('Affiliate link added:', result);
                            } catch (e) {
                                console.error('Error adding affiliate link:', e);
                            }
                        }
                    }
                }
            }

            const siteSelector = document.getElementById('site_selector');

            // Check which mode we're in
            if (siteSelector.value) {
                // Pre-configured site mode - just use site_name
                formData.set('site_name', siteSelector.value);
                // Remove manual fields (not needed)
                formData.delete('site_url');
                formData.delete('username');
                formData.delete('application_password');
            } else {
                // Manual mode - must have all manual fields
                const siteUrl = formData.get('site_url');
                const username = formData.get('username');
                const appPassword = formData.get('application_password');

                if (!siteUrl || !username || !appPassword) {
                    alert('Please fill in all required fields (Site URL, Username, Password)');
                    return;
                }

                // Extract site name from URL for state tracking
                const siteName = extractSiteName(siteUrl);
                formData.set('site_name', siteName);
                console.log(`Extracted site name: ${siteName} from URL: ${siteUrl}`);
            }

            // Check GSC file
            const gscFile = document.getElementById('gsc_file');
            if (!gscFile.files.length) {
                alert('Please upload a GSC data file');
                return;
            }

            const executionMode = formData.get('execution_mode');
            const isExecution = executionMode !== 'view_plan';

            // Confirm execution with detailed info
            if (isExecution) {
                const limit = formData.get('limit');
                const hasAffiliateLinks = affiliateMode !== 'none' && enableAffiliateUpdates;

                let confirmMsg = '';
                if (executionMode === 'execute_top_n') {
                    confirmMsg = `🎯 Execute Top ${limit || 'N'} Actions\n\n`;
                    confirmMsg += `This will run the ${limit || 'N'} highest-priority SEO improvements.\n`;
                } else {
                    confirmMsg = `🚀 Execute All Planned Actions\n\n`;
                    confirmMsg += `This will run ALL recommended SEO improvements based on your GSC data.\n`;
                }

                confirmMsg += `\nActions may include:\n`;
                confirmMsg += `• Creating new content\n`;
                confirmMsg += `• Updating existing articles\n`;
                confirmMsg += `• Deleting underperforming content\n`;
                confirmMsg += `• Setting up 301 redirects\n`;

                if (hasAffiliateLinks) {
                    confirmMsg += `\n✅ Affiliate links will be added to created/updated articles\n`;
                } else {
                    confirmMsg += `\n⚠️  Affiliate links NOT enabled\n`;
                }

                confirmMsg += `\nThis will modify your WordPress site. Continue?`;

                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            const endpoint = isExecution ? '/execute' : '/analyze';
            const loadingMsg = isExecution
                ? 'Executing AI-powered pipeline... This may take several minutes.'
                : 'Running AI analysis with niche intelligence...';

            showLoading(loadingMsg);

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    body: formData
                });

                // Get response text first to see what we're actually receiving
                const responseText = await response.text();
                console.log('API Response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}...`);
                }

                if (!response.ok) {
                    const errorMsg = data.details || data.error || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }

                showResults(data);
            } catch (error) {
                console.error('Pipeline error:', error);
                showError(error.message || 'An unknown error occurred');
            }
        }
    </script>
</body>
</html>
